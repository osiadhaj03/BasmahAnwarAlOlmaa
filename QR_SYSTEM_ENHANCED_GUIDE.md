# دليل نظام QR Code المحدث - أنوار العلماء

## التحديثات الجديدة

### 1. منطق توليد QR Code
- **قبل التحديث**: كان يمكن توليد QR في أي وقت (مع تحقق بسيط)
- **بعد التحديث**: 
  - يمكن توليد QR فقط في يوم الدرس المحدد (مثل الأحد)
  - يمكن توليد QR فقط خلال وقت الدرس (من start_time إلى end_time)
  - في بيئة التطوير: يُسمح بالتوليد في أي وقت للاختبار

### 2. صلاحية QR Code
- **قبل التحديث**: صالح لمدة 15 دقيقة فقط
- **بعد التحديث**: 
  - QR واحد صالح طوال مدة الدرس (مثلاً ساعتين)
  - لا يتم تجديد QR تلقائياً أثناء الدرس
  - QR ينتهي تلقائياً عند انتهاء وقت الدرس

### 3. استخدام QR متعدد
- **قبل التحديث**: QR يُحدد كـ "مستخدم" بعد أول مسح
- **بعد التحديث**: 
  - يمكن لعدد غير محدود من الطلاب مسح نفس QR
  - كل طالب يسجل حضور منفصل
  - لا يمكن للطالب نفسه التسجيل مرتين في نفس اليوم

### 4. تحديد حالة الحضور
- **جديد**: نظام تحديد الحالة حسب وقت المسح:
  - **حاضر**: مسح QR خلال أول 15 دقيقة من بداية الدرس
  - **متأخر**: مسح QR بعد أول 15 دقيقة من بداية الدرس
  - **غائب**: عدم مسح QR أو المسح خارج وقت الدرس

### 5. العداد الزمني
- **قبل التحديث**: يعرض الوقت المتبقي للـ QR Token (15 دقيقة)
- **بعد التحديث**: يعرض الوقت المتبقي حتى نهاية الدرس

## الملفات المحدثة

### 1. `app/Models/Lesson.php`
```php
// دوال جديدة مضافة:
- getAttendanceStatus(): تحديد حالة الحضور (حاضر/متأخر)
- getRemainingLessonTime(): حساب الوقت المتبقي للدرس
- canGenerateQR(): تحديث منطق التحقق من إمكانية توليد QR
- generateQRCodeToken(): تحديث لمنع تكرار التوليد في نفس اليوم
- getValidQRToken(): تحديث للبحث عن token حسب التاريخ
```

### 2. `app/Models/QrToken.php`
```php
// تحديثات:
- isUsed(): إرجاع false دائماً (السماح باستخدام متعدد)
- isValid(): التحقق من انتهاء الوقت فقط
- markAsUsed(): دالة فارغة (عدم تحديد كمستخدم)
```

### 3. `app/Http/Controllers/QRCodeController.php`
```php
// تحديثات:
- scanAttendance(): تحديد حالة الحضور حسب وقت المسح
- getTokenInfo(): إضافة lesson_remaining_minutes
- refreshToken(): استخدام الوقت المتبقي للدرس
```

### 4. `resources/views/admin/lessons/qr-display.blade.php`
```javascript
// تحديثات:
- عرض العداد حسب وقت الدرس وليس Token
- تحديث النصوص التوضيحية
- تحديث منطق العرض
```

## كيفية عمل النظام الآن

### 1. توليد QR Code
1. المعلم يدخل على صفحة عرض QR للدرس
2. النظام يتحقق من:
   - هل اليوم الحالي = يوم الدرس؟
   - هل الوقت الحالي خلال وقت الدرس؟
3. إذا كانت الشروط مستوفاة:
   - يتم توليد QR صالح حتى نهاية الدرس
   - يظهر العداد الزمني للوقت المتبقي
4. إذا لم تكن الشروط مستوفاة:
   - يظهر رسالة توضح متى سيكون QR متاحاً

### 2. مسح QR Code
1. الطالب يمسح QR Code باستخدام تطبيق المسح
2. النظام يتحقق من:
   - صلاحية Token (لم ينته وقت الدرس)
   - الطالب مسجل في الدرس
   - لم يسجل حضور مسبقاً اليوم
3. تحديد حالة الحضور:
   - إذا كان المسح خلال أول 15 دقيقة: "حاضر"
   - إذا كان المسح بعد 15 دقيقة: "متأخر"
4. تسجيل الحضور في قاعدة البيانات

### 3. إحصائيات الحضور
- **حاضر**: الطلاب الذين مسحوا QR خلال أول 15 دقيقة
- **متأخر**: الطلاب الذين مسحوا QR بعد 15 دقيقة
- **غائب**: الطلاب الذين لم يمسحوا QR

## الأمان والصلاحية

### 1. التحقق من الوقت
- QR صالح فقط خلال وقت الدرس الفعلي
- لا يمكن مسح QR خارج اليوم المحدد
- لا يمكن مسح QR قبل أو بعد وقت الدرس

### 2. التحقق من الصلاحيات
- فقط المعلم المسؤول أو المدير يمكنه توليد QR
- فقط الطلاب المسجلين يمكنهم مسح QR
- تسجيل واحد فقط لكل طالب يومياً

### 3. تشفير Token
- استخدام hash آمن مع مفتاح التطبيق
- تضمين معرف الدرس والتاريخ والوقت
- منع إعادة استخدام tokens قديمة

## إجابة على الأسئلة

### س: هل إذا مسح أكثر من طالب نفس QR يُسجل حضورهم جميعاً؟
**ج: نعم، تماماً!** 
- QR Code واحد يمكن مسحه من عدد غير محدود من الطلاب
- كل طالب يحصل على تسجيل حضور منفصل ومستقل
- الطالب نفسه لا يمكنه التسجيل مرتين في نفس اليوم
- حالة الحضور تُحدد حسب وقت مسح كل طالب

### س: كيف يتم تحديد حالة الحضور؟
**ج:**
- **الـ 15 دقيقة الأولى**: أي طالب يمسح QR = "حاضر"
- **بعد 15 دقيقة**: أي طالب يمسح QR = "متأخر"
- **خارج وقت الدرس**: لا يمكن المسح = "غائب"

### س: متى ينتهي QR Code؟
**ج:**
- QR ينتهي تلقائياً عند انتهاء وقت الدرس
- لا يمكن تجديده أثناء الدرس (QR واحد فقط لكل درس)
- يُحذف تلقائياً في اليوم التالي

## بيئة التطوير vs الإنتاج

### في بيئة التطوير (APP_ENV=local):
- يمكن توليد QR في أي وقت
- QR صالح لمدة ساعة
- يظهر رسالة "وضع التطوير"

### في بيئة الإنتاج:
- QR متاح فقط في يوم ووقت الدرس
- QR صالح حتى نهاية الدرس
- تطبيق صارم للقيود الزمنية
